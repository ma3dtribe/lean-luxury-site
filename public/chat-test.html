ƒ<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MA3DTRIBE Chat</title>
  <style>
    :root{
      --bg:#0b1220;
      --panel:#0f1a33;
      --line:#1d2b55;
      --text:#e8ecff;
      --muted:#9aa6d6;
      --accent:#4dd4ff;
      --web:#27d07d;
      --twitch:#a970ff;
    }
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;}
    .wrap{max-width:860px;margin:0 auto;padding:14px;}
    .header{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      padding:12px 14px;border:1px solid var(--line);border-radius:14px;background:linear-gradient(180deg,var(--panel),#0c1630);
      position:sticky;top:0;z-index:5;
    }
    .title{font-weight:800;letter-spacing:.4px}
    .status{font-size:12px;color:var(--muted)}
    .chat{
      margin-top:12px;border:1px solid var(--line);border-radius:14px;overflow:hidden;background:rgba(255,255,255,.03);
    }
    .msgs{height:460px;overflow:auto;padding:12px 12px 2px;}
    .row{display:flex;gap:10px;margin:10px 0;align-items:flex-start;}
    .avatar{
      width:34px;height:34px;border-radius:10px;background:#16244a;border:1px solid var(--line);
      display:flex;align-items:center;justify-content:center;font-weight:800;font-size:12px;color:var(--accent);flex:0 0 auto;
    }
    .bubble{
      max-width:75%;
      border:1px solid var(--line);border-radius:14px;padding:10px 12px;background:#0f1a33;
      box-shadow:0 8px 22px rgba(0,0,0,.25);
    }
    .meta{display:flex;gap:8px;align-items:center;margin-bottom:6px;font-size:12px;color:var(--muted)}
    .name{font-weight:800}
    .badge{
      font-size:11px;border-radius:999px;padding:2px 8px;border:1px solid var(--line);
      background:rgba(255,255,255,.04);
    }
    .badge.web{border-color:rgba(39,208,125,.35);color:var(--web)}
    .badge.twitch{border-color:rgba(169,112,255,.35);color:var(--twitch)}
    .time{margin-left:auto;color:var(--muted)}
    .text{white-space:pre-wrap;word-break:break-word;font-size:14px;line-height:1.35}
    .gif{
      margin-top:10px;border:1px solid var(--line);border-radius:12px;overflow:hidden;
      background:rgba(0,0,0,.25);
    }
    .gif img{display:block;max-width:320px;width:100%;height:auto}
    .composer{
      display:flex;gap:8px;padding:12px;border-top:1px solid var(--line);background:rgba(0,0,0,.18);
      align-items:center;
    }
    .input{
      flex:1;border:1px solid var(--line);background:#0a1430;color:var(--text);
      border-radius:12px;padding:10px 12px;outline:none;
    }
    .btn{
      border:1px solid var(--line);background:#11204a;color:var(--text);
      border-radius:12px;padding:10px 12px;cursor:pointer;font-weight:800;
      display:flex;gap:8px;align-items:center;
    }
    .btn:active{transform:translateY(1px)}
    .btn.gif{background:#161a3a}
    .modalBack{
      position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;z-index:20;
      padding:14px;
    }
    .modal{
      width:min(920px, 96vw);
      background:linear-gradient(180deg,#0f1a33,#0c1630);
      border:1px solid var(--line);border-radius:16px;box-shadow:0 20px 60px rgba(0,0,0,.45);
      overflow:hidden;
    }
    .modalTop{
      display:flex;gap:10px;align-items:center;justify-content:space-between;padding:12px;border-bottom:1px solid var(--line);
    }
    .modalTop input{
      width:100%;
      border:1px solid var(--line);background:#0a1430;color:var(--text);
      border-radius:12px;padding:10px 12px;outline:none;
    }
    .grid{
      display:grid;grid-template-columns:repeat(4,1fr);gap:8px;padding:12px;max-height:55vh;overflow:auto;
    }
    .tile{
      border:1px solid var(--line);border-radius:12px;overflow:hidden;cursor:pointer;background:rgba(0,0,0,.25);
    }
    .tile img{display:block;width:100%;height:140px;object-fit:cover}
    .small{font-size:12px;color:var(--muted)}
    @media (max-width:720px){
      .bubble{max-width:100%}
      .grid{grid-template-columns:repeat(2,1fr)}
      .tile img{height:160px}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="header">
      <div>
        <div class="title">MA3DTRIBE • Chat</div>
        <div class="status" id="status">Connecting…</div>
      </div>
      <div class="status" id="me"></div>
    </div>

    <div class="chat">
      <div class="msgs" id="msgs"></div>
      <div class="composer">
        <button class="btn gif" id="gifBtn">GIF</button>
        <input class="input" id="text" placeholder="Type a message…" maxlength="300" />
        <button class="btn" id="send">Send</button>
      </div>
    </div>
  </div>

  <!-- GIF Picker Modal -->
  <div class="modalBack" id="modalBack">
    <div class="modal">
      <div class="modalTop">
        <div style="font-weight:800">Pick a GIF</div>
        <div style="flex:1">
          <input id="gifQuery" placeholder="Search GIFs (powered by Tenor)…" />
          <div class="small" style="margin-top:6px">Tip: search “dancehall”, “airhorn”, “party”, “big tune”</div>
        </div>
        <button class="btn" id="closeGif">Close</button>
      </div>
      <div class="grid" id="gifGrid"></div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import {
      getFirestore, collection, onSnapshot, addDoc, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyB7QQNTOJg-GzFZc1Fia2ULYKFzNd7uwMU",
      authDomain: "ma3dtribe-chat.firebaseapp.com",
      projectId: "ma3dtribe-chat",
      storageBucket: "ma3dtribe-chat.firebasestorage.app",
      messagingSenderId: "143335444804",
      appId: "1:143335444804:web:c5d143218c5b3295764711"
    };

    // ✅ TENOR KEY (temporary demo key)
    // For production we’ll switch to your own key.
    const TENOR_KEY = "LIVDSRZULELA";

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const statusEl = document.getElementById("status");
    const meEl = document.getElementById("me");
    const msgsEl = document.getElementById("msgs");
    const textEl = document.getElementById("text");
    const sendBtn = document.getElementById("send");

    const modalBack = document.getElementById("modalBack");
    const gifBtn = document.getElementById("gifBtn");
    const closeGif = document.getElementById("closeGif");
    const gifQuery = document.getElementById("gifQuery");
    const gifGrid = document.getElementById("gifGrid");

    const guestName =
      localStorage.getItem("guestName") ||
      (() => {
        const name = "Guest-" + Math.floor(Math.random() * 900 + 100);
        localStorage.setItem("guestName", name);
        return name;
      })();

    meEl.textContent = "You: " + guestName;

    function nameColor(name){
      let h=0; for (let i=0;i<name.length;i++) h=(h*31 + name.charCodeAt(i))>>>0;
      const hue = h % 360;
      return `hsl(${hue} 85% 70%)`;
    }

    function fmtTime(ts){
      if (!ts) return "";
      try{
        const d = ts.toDate ? ts.toDate() : new Date(ts);
        return d.toLocaleTimeString([], {hour:"2-digit", minute:"2-digit"});
      }catch{ return ""; }
    }

    function renderMessage(m){
      const source = (m.source || "web").toLowerCase();
      const badgeClass = source === "twitch" ? "twitch" : "web";
      const badgeText  = source === "twitch" ? "TWITCH" : "WEB";
      const initial = (m.displayName || "?").slice(0,2).toUpperCase();
      const color = nameColor(m.displayName || "Guest");

      const row = document.createElement("div");
      row.className = "row";

      const safeName = (m.displayName || "Guest").replaceAll("<","&lt;");
      const safeText = (m.text || "").replaceAll("<","&lt;");

      row.innerHTML = `
        <div class="avatar" style="color:${color}">${initial}</div>
        <div class="bubble">
          <div class="meta">
            <span class="badge ${badgeClass}">${badgeText}</span>
            <span class="name" style="color:${color}">${safeName}</span>
            <span class="time">${fmtTime(m.timestamp)}</span>
          </div>
          <div class="text">${safeText}</div>
          ${m.gifUrl ? `<div class="gif"><img alt="gif" src="${m.gifUrl}"></div>` : ``}
        </div>
      `;
      return row;
    }

    onSnapshot(
      collection(db, "messages"),
      (snapshot) => {
        statusEl.textContent = "Connected ✓ Messages: " + snapshot.size;

        msgsEl.innerHTML = "";
        snapshot.forEach((doc) => msgsEl.appendChild(renderMessage(doc.data())));
        msgsEl.scrollTop = msgsEl.scrollHeight;
      },
      (err) => {
        statusEl.textContent = "Error: " + err.message;
        console.error(err);
      }
    );

    async function send({ text, gifUrl }){
      const cleanText = (text || "").trim();

      if (!cleanText && !gifUrl) return;

      await addDoc(collection(db, "messages"), {
        source: "web",
        displayName: guestName,
        text: cleanText,
        gifUrl: gifUrl || null,
        createdAtMs: Date.now(),
        timestamp: serverTimestamp()
      });

      textEl.value = "";
      textEl.focus();
    }

    sendBtn.addEventListener("click", () => send({ text: textEl.value }));
    textEl.addEventListener("keydown", (e)=>{ if(e.key==="Enter") send({ text: textEl.value }); });

    // GIF picker
    function openGif(){
      modalBack.style.display = "flex";
      gifQuery.value = "";
      gifGrid.innerHTML = "";
      gifQuery.focus();
      loadTrending();
    }
    function closeGifModal(){
      modalBack.style.display = "none";
    }
    gifBtn.addEventListener("click", openGif);
    closeGif.addEventListener("click", closeGifModal);
    modalBack.addEventListener("click", (e)=>{ if(e.target === modalBack) closeGifModal(); });

    async function loadTrending(){
      const url = `https://tenor.googleapis.com/v2/featured?key=${TENOR_KEY}&client_key=ma3dtribe&limit=24&media_filter=gif`;
      const res = await fetch(url);
      const data = await res.json();
      renderGifGrid(data.results || []);
    }

    let searchTimer = null;
    gifQuery.addEventListener("input", () => {
      clearTimeout(searchTimer);
      const q = gifQuery.value.trim();
      searchTimer = setTimeout(() => {
        if (!q) return loadTrending();
        searchGifs(q);
      }, 300);
    });

    async function searchGifs(q){
      const url = `https://tenor.googleapis.com/v2/search?q=${encodeURIComponent(q)}&key=${TENOR_KEY}&client_key=ma3dtribe&limit=24&media_filter=gif`;
      const res = await fetch(url);
      const data = await res.json();
      renderGifGrid(data.results || []);
    }

    function renderGifGrid(results){
      gifGrid.innerHTML = "";
      results.forEach((r) => {
        const media = r.media_formats?.gif;
        const gifUrl = media?.url;
        if (!gifUrl) return;

        const div = document.createElement("div");
        div.className = "tile";
        div.innerHTML = `<img alt="gif" src="${gifUrl}">`;
        div.addEventListener("click", async () => {
          closeGifModal();
          await send({ text: "", gifUrl });
        });
        gifGrid.appendChild(div);
      });
    }
  </script>
  <!-- ===================== -->
<!-- GIPHY GIF PICKER START -->
<!-- ===================== -->

<button id="gifBtn" type="button" style="margin-left:8px;">GIF</button>

<div id="gifModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.8); z-index:99999;">
  <div style="background:#111; max-width:700px; margin:8% auto; padding:14px; border-radius:12px;">
    <div style="display:flex; gap:8px; margin-bottom:10px;">
      <input id="gifSearch" placeholder="Search GIFs and press Enter"
        style="flex:1; padding:10px; border-radius:8px; border:0;" />
      <button id="gifClose" type="button" style="padding:10px 14px; border-radius:8px; border:0; cursor:pointer;">
        Close
      </button>
    </div>

    <div id="gifResults" style="display:grid; grid-template-columns:repeat(3,1fr); gap:10px;"></div>
  </div>
</div>

<script>
  // 1) PASTE YOUR REAL GIPHY KEY HERE:
  const GIPHY_API_KEY = "3zxGKg42FRkYfKmUrnjmobhQch37O33L";

  const gifBtn = document.getElementById("gifBtn");
  const gifModal = document.getElementById("gifModal");
  const gifClose = document.getElementById("gifClose");
  const gifResults = document.getElementById("gifResults");
  const gifSearch = document.getElementById("gifSearch");

  gifBtn.addEventListener("click", () => {
    gifModal.style.display = "block";
    gifSearch.value = "";
    gifResults.innerHTML = "";
    gifSearch.focus();
  });

  gifClose.addEventListener("click", () => {
    gifModal.style.display = "none";
  });

  gifSearch.addEventListener("keydown", async (e) => {
    if (e.key !== "Enter") return;
    const q = gifSearch.value.trim();
    if (!q) return;

    gifResults.innerHTML = "Loading...";

    const res = await fetch(
      `https://api.giphy.com/v1/gifs/search?api_key=${encodeURIComponent(GIPHY_API_KEY)}&q=${encodeURIComponent(q)}&limit=12&rating=pg-13`
    );

    const json = await res.json();
    gifResults.innerHTML = "";

    (json.data || []).forEach(gif => {
      const url = gif?.images?.fixed_width?.url;
      if (!url) return;

      const img = document.createElement("img");
      img.src = url;
      img.style.width = "100%";
      img.style.borderRadius = "10px";
      img.style.cursor = "pointer";

      img.addEventListener("click", () => {
        sendGif(url);
        gifModal.style.display = "none";
      });

      gifResults.appendChild(img);
    });
  });

function sendGif(url) {
  const chat = document.getElementById("chatMessages"); // or whatever your message container is

  const img = document.createElement("img");
  img.src = url;
  img.style.maxWidth = "220px";
  img.style.borderRadius = "10px";
  img.style.display = "block";
  img.style.margin = "6px 0";

  chat.appendChild(img);
}

</script>

<!-- =================== -->
<!-- GIPHY GIF PICKER END -->
<!-- =================== -->
</body>
</html>



