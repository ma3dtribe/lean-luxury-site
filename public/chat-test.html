<script>
/* =========================
   CONFIG
========================= */
const GIPHY_API_KEY = "3zxGKg42FRkYfKmUrnjmobhQch37O33L";

const SUPABASE_URL = "https://tgqfplueqjhsywkcjaal.supabase.co";
const SUPABASE_ANON_KEY = "sb_publishable_xzNaO0t5I";
const ROOM = "ma3dtribe";

const USER_STORAGE_KEY = "ma3dtribe_username";

/* =========================
   SUPABASE INIT
========================= */
const supabase = window.supabase.createClient(
  SUPABASE_URL,
  SUPABASE_ANON_KEY
);

/* =========================
   ELEMENTS
========================= */
const chatMessages = document.getElementById("chatMessages");
const messageInput = document.getElementById("messageInput");
const sendBtn = document.getElementById("sendBtn");

const userDisplay = document.getElementById("userDisplay");
const changeNameBtn = document.getElementById("changeName");

const gifBtn = document.getElementById("gifBtn");
const gifModal = document.getElementById("gifModal");
const gifClose = document.getElementById("gifClose");
const gifTrending = document.getElementById("gifTrending");
const gifSearch = document.getElementById("gifSearch");
const gifResults = document.getElementById("gifResults");

/* =========================
   USERNAME
========================= */
function getUsername() {
  let name = (localStorage.getItem(USER_STORAGE_KEY) || "").trim();
  if (!name) {
    name = prompt("Enter your chat name:") || "Guest";
    localStorage.setItem(USER_STORAGE_KEY, name);
  }
  return name;
}

let USERNAME = getUsername();
userDisplay.textContent = USERNAME;

changeNameBtn.onclick = () => {
  const n = prompt("Change your name:", USERNAME);
  if (n) {
    USERNAME = n.trim();
    localStorage.setItem(USER_STORAGE_KEY, USERNAME);
    userDisplay.textContent = USERNAME;
  }
};

/* =========================
   UI HELPERS
========================= */
function scrollBottom() {
  chatMessages.scrollTop = chatMessages.scrollHeight;
}

function renderMessage(row) {
  const div = document.createElement("div");
  div.className = "msg " + (row.username === USERNAME ? "me" : "them");

  const meta = document.createElement("div");
  meta.className = "meta";
  meta.textContent = row.username;
  div.appendChild(meta);

  if (row.kind === "gif") {
    const img = document.createElement("img");
    img.src = row.content;
    div.appendChild(img);
  } else {
    div.appendChild(document.createTextNode(row.content));
  }

  chatMessages.appendChild(div);
  scrollBottom();
}

/* =========================
   LOAD EXISTING MESSAGES
========================= */
async function loadMessages() {
  const { data } = await supabase
    .from("messages")
    .select("*")
    .eq("room", ROOM)
    .order("created_at", { ascending: true })
    .limit(50);

  chatMessages.innerHTML = "";
  data?.forEach(renderMessage);
}

/* =========================
   REALTIME SUBSCRIBE
========================= */
supabase
  .channel("room-" + ROOM)
  .on(
    "postgres_changes",
    { event: "INSERT", schema: "public", table: "messages", filter: `room=eq.${ROOM}` },
    (payload) => renderMessage(payload.new)
  )
  .subscribe((status) => {
    if (status === "CHANNEL_ERROR" || status === "TIMED_OUT") {
      chatMessages.innerHTML =
        `<div class="msg them"><div class="meta">System</div>Realtime connection issue. Refresh the page.</div>`;
    }
  });


/* =========================
   SEND MESSAGE
========================= */
async function send(kind, content) {
  if (!content.trim()) return;

  await supabase.from("messages").insert({
    room: ROOM,
    username: USERNAME,
    kind,
    content
  });
}

sendBtn.onclick = () => {
  send("text", messageInput.value);
  messageInput.value = "";
};

messageInput.addEventListener("keydown", e => {
  if (e.key === "Enter") sendBtn.click();
});

/* =========================
   GIF MODAL
========================= */
gifBtn.onclick = async () => {
  gifModal.style.display = "block";
  gifResults.innerHTML = "Loading…";
  const res = await fetch(
    `https://api.giphy.com/v1/gifs/trending?api_key=${GIPHY_API_KEY}&limit=18`
  );
  const json = await res.json();
  renderGifs(json.data);
};

gifClose.onclick = () => gifModal.style.display = "none";

gifSearch.onkeydown = async e => {
  if (e.key !== "Enter") return;
  const q = gifSearch.value.trim();
  if (!q) return;

  gifResults.innerHTML = "Searching…";
  const res = await fetch(
    `https://api.giphy.com/v1/gifs/search?api_key=${GIPHY_API_KEY}&q=${encodeURIComponent(q)}&limit=18`
  );
  const json = await res.json();
  renderGifs(json.data);
};

function renderGifs(list) {
  gifResults.innerHTML = "";
  list.forEach(g => {
    const url = g.images.fixed_width.url;
    const img = document.createElement("img");
    img.src = url;
    img.onclick = () => {
      send("gif", url);
      gifModal.style.display = "none";
    };
    gifResults.appendChild(img);
  });
}

/* =========================
   START
========================= */
loadMessages();
</script>





