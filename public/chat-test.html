<!-- 1) Make sure Supabase JS is loaded BEFORE your script -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
document.addEventListener("DOMContentLoaded", () => {
  /* =========================
     CONFIG
  ========================= */
  const GIPHY_API_KEY = "3zxGKg42FRkYfKmUrnjmobhQch37O33L";

  const SUPABASE_URL = "https://tgqfplueqjhsywkcjaal.supabase.co";
  const SUPABASE_ANON_KEY = "PASTE_YOUR_REAL_SUPABASE_ANON_KEY_HERE"; // must be the long anon/public key
  const ROOM = "ma3dtribe";

  const USER_STORAGE_KEY = "ma3dtribe_username";

  /* =========================
     GUARDS
  ========================= */
  if (!window.supabase) {
    console.error("Supabase library not found. Did the CDN script load?");
    alert("Supabase library not loaded. Check your script tag.");
    return;
  }

  if (!SUPABASE_ANON_KEY || SUPABASE_ANON_KEY.length < 50) {
    console.error("Supabase anon key looks invalid/too short:", SUPABASE_ANON_KEY);
    alert("Your Supabase anon/public key looks invalid. Paste the full anon key from Supabase Project Settings → API.");
    return;
  }

  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  /* =========================
     ELEMENTS
  ========================= */
  const chatMessages = document.getElementById("chatMessages");
  const messageInput = document.getElementById("messageInput");
  const sendBtn = document.getElementById("sendBtn");

  const userDisplay = document.getElementById("userDisplay");
  const changeNameBtn = document.getElementById("changeName");

  const gifBtn = document.getElementById("gifBtn");
  const gifModal = document.getElementById("gifModal");
  const gifClose = document.getElementById("gifClose");
  const gifSearch = document.getElementById("gifSearch");
  const gifResults = document.getElementById("gifResults");

  const requiredIds = [
    ["chatMessages", chatMessages],
    ["messageInput", messageInput],
    ["sendBtn", sendBtn],
    ["userDisplay", userDisplay],
    ["changeName", changeNameBtn],
    ["gifBtn", gifBtn],
    ["gifModal", gifModal],
    ["gifClose", gifClose],
    ["gifSearch", gifSearch],
    ["gifResults", gifResults],
  ];
  const missing = requiredIds.filter(([_, el]) => !el).map(([id]) => id);
  if (missing.length) {
    console.error("Missing required HTML elements:", missing);
    alert("Chat HTML is missing elements: " + missing.join(", "));
    return;
  }

  /* =========================
     USERNAME
  ========================= */
  function getUsername() {
    let name = (localStorage.getItem(USER_STORAGE_KEY) || "").trim();
    if (!name) {
      name = (prompt("Enter your chat name:") || "Guest").trim();
      localStorage.setItem(USER_STORAGE_KEY, name);
    }
    return name;
  }

  let USERNAME = getUsername();
  userDisplay.textContent = USERNAME;

  changeNameBtn.onclick = () => {
    const n = prompt("Change your name:", USERNAME);
    if (n && n.trim()) {
      USERNAME = n.trim();
      localStorage.setItem(USER_STORAGE_KEY, USERNAME);
      userDisplay.textContent = USERNAME;
    }
  };

  /* =========================
     UI HELPERS
  ========================= */
  function scrollBottom() {
    chatMessages.scrollTop = chatMessages.scrollHeight;
  }

  function renderMessage(row) {
    const div = document.createElement("div");
    div.className = "msg " + (row.username === USERNAME ? "me" : "them");

    const meta = document.createElement("div");
    meta.className = "meta";
    meta.textContent = row.username || "Guest";
    div.appendChild(meta);

    if (row.kind === "gif") {
      const img = document.createElement("img");
      img.src = row.content;
      img.loading = "lazy";
      div.appendChild(img);
    } else {
      div.appendChild(document.createTextNode(row.content || ""));
    }

    chatMessages.appendChild(div);
    scrollBottom();
  }

  /* =========================
     LOAD EXISTING MESSAGES
  ========================= */
  async function loadMessages() {
    const { data, error } = await supabase
      .from("messages")
      .select("*")
      .eq("room", ROOM)
      .order("created_at", { ascending: true })
      .limit(50);

    if (error) {
      console.error("loadMessages error:", error);
      chatMessages.innerHTML =
        `<div class="msg them"><div class="meta">System</div>Failed to load messages. Check console.</div>`;
      return;
    }

    chatMessages.innerHTML = "";
    (data || []).forEach(renderMessage);
  }

  /* =========================
     REALTIME SUBSCRIBE
  ========================= */
  const channel = supabase
    .channel("room-" + ROOM)
    .on(
      "postgres_changes",
      { event: "INSERT", schema: "public", table: "messages", filter: `room=eq.${ROOM}` },
      (payload) => renderMessage(payload.new)
    )
    .subscribe((status) => {
      console.log("Realtime status:", status);
      if (status === "CHANNEL_ERROR" || status === "TIMED_OUT") {
        chatMessages.innerHTML =
          `<div class="msg them"><div class="meta">System</div>Realtime connection issue. Refresh the page.</div>`;
      }
    });

  /* =========================
     SEND MESSAGE
  ========================= */
  async function send(kind, content) {
    const text = (content || "").trim();
    if (!text) return;

    const { error } = await supabase.from("messages").insert({
      room: ROOM,
      username: USERNAME,
      kind,
      content: text
    });

    if (error) {
      console.error("send error:", error);
      alert("Message failed to send. Check console.");
    }
  }

  sendBtn.onclick = async () => {
    const msg = messageInput.value;
    messageInput.value = "";
    await send("text", msg);
  };

  messageInput.addEventListener("keydown", (e) => {
    if (e.key === "Enter") sendBtn.click();
  });

  /* =========================
     GIF MODAL
  ========================= */
  gifBtn.onclick = async () => {
    gifModal.style.display = "block";
    gifResults.innerHTML = "Loading…";

    try {
      const res = await fetch(
        `https://api.giphy.com/v1/gifs/trending?api_key=${GIPHY_API_KEY}&limit=18`
      );
      const json = await res.json();
      renderGifs(json.data || []);
    } catch (err) {
      console.error("Giphy trending error:", err);
      gifResults.innerHTML = "Failed to load GIFs.";
    }
  };

  gifClose.onclick = () => (gifModal.style.display = "none");

  gifSearch.onkeydown = async (e) => {
    if (e.key !== "Enter") return;
    const q = gifSearch.value.trim();
    if (!q) return;

    gifResults.innerHTML = "Searching…";
    try {
      const res = await fetch(
        `https://api.giphy.com/v1/gifs/search?api_key=${GIPHY_API_KEY}&q=${encodeURIComponent(q)}&limit=18`
      );
      const json = await res.json();
      renderGifs(json.data || []);
    } catch (err) {
      console.error("Giphy search error:", err);
      gifResults.innerHTML = "Search failed.";
    }
  };

  function renderGifs(list) {
    gifResults.innerHTML = "";
    list.forEach((g) => {
      const url = g?.images?.fixed_width?.url;
      if (!url) return;

      const img = document.createElement("img");
      img.src = url;
      img.loading = "lazy";
      img.onclick = () => {
        send("gif", url);
        gifModal.style.display = "none";
      };
      gifResults.appendChild(img);
    });

    if (!gifResults.children.length) gifResults.innerHTML = "No results.";
  }

  /* =========================
     START
  ========================= */
  loadMessages();
});
</script>






