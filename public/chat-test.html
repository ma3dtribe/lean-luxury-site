<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ma3dTribe Chat + GIPHY</title>

  <style>
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
      background:#0b0f14;
      color:#e9eef6;
    }
    .wrap{max-width:860px;margin:0 auto;padding:16px;}
    .card{
      background:#111826;
      border:1px solid rgba(255,255,255,.08);
      border-radius:14px;
      overflow:hidden;
    }
    .header{
      padding:14px 16px;
      border-bottom:1px solid rgba(255,255,255,.08);
      display:flex;gap:10px;align-items:center;
    }
    .dot{
      width:10px;height:10px;border-radius:50%;
      background:#22c55e;
      box-shadow:0 0 18px rgba(34,197,94,.35);
      flex:0 0 auto;
    }
    .title{font-weight:700;}
    .sub{opacity:.85;font-size:13px;margin-left:auto;display:flex;align-items:center;gap:10px;}
    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:6px 10px;border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.04);
      font-size:13px;
    }
    .pill b{font-weight:700;}
    .linkBtn{
      background:transparent;border:0;color:#93c5fd;cursor:pointer;
      padding:0;font-size:13px;
    }
    .linkBtn:hover{text-decoration:underline;}

    #chatMessages{
      height:58vh;overflow:auto;
      padding:14px 16px;
      display:flex;flex-direction:column;gap:10px;
    }
    .msg{
      max-width:78%;
      padding:10px 12px;border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      line-height:1.25;
      word-wrap:break-word;
    }
    .me{margin-left:auto;background:#1a2a42;}
    .them{margin-right:auto;background:#121b2b;opacity:.95;}
    .meta{font-size:12px;opacity:.7;margin-bottom:4px;}
    .msg img{
      max-width:260px;width:100%;
      border-radius:12px;display:block;
      border:1px solid rgba(255,255,255,.10);
    }

    .composer{
      padding:12px;border-top:1px solid rgba(255,255,255,.08);
      display:flex;gap:10px;align-items:center;
    }
    #messageInput{
      flex:1;
      padding:12px;border-radius:12px;
      border:1px solid rgba(255,255,255,.14);
      background:#0e1623;color:#e9eef6;outline:none;
    }
    .btn{
      padding:10px 12px;border-radius:12px;
      border:1px solid rgba(255,255,255,.14);
      background:#0e1623;color:#e9eef6;cursor:pointer;
    }
    .btn:hover{filter:brightness(1.08);}
    .btnPrimary{background:#2563eb;border-color:#2563eb;}

    #gifModal{
      display:none;
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.75);
      z-index:9999;
      pointer-events:none;
    }
    #gifModal.show{
      display:block;
      pointer-events:auto;
    }
    .modalBox{
      background:#0f1623;
      border:1px solid rgba(255,255,255,.12);
      border-radius:14px;
      max-width:820px;
      margin:6vh auto;
      padding:12px;
    }
    .modalTop{
      display:flex;gap:10px;align-items:center;
      padding:6px;
    }
    #gifSearch{
      flex:1;
      padding:12px;border-radius:12px;
      border:1px solid rgba(255,255,255,.14);
      background:#0b1220;color:#e9eef6;outline:none;
    }
    .hint{opacity:.7;font-size:12px;padding:0 10px 10px;}
    #gifResults{
      padding:8px;
      display:grid;
      grid-template-columns:repeat(3,1fr);
      gap:10px;
      max-height:62vh;
      overflow:auto;
    }
    #gifResults img{
      width:100%;
      border-radius:12px;
      cursor:pointer;
      border:1px solid rgba(255,255,255,.10);
    }
    #gifResults img:hover{
      transform:translateY(-1px);
      transition:.08s;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card">
      <div class="header">
        <div class="dot"></div>
        <div class="title">Ma3dTribe Chat (Test)</div>
        <div class="sub">
          <span class="pill">
            Logged in as: <b id="userDisplay">...</b> ·
            <button id="changeName" class="linkBtn" type="button">Change</button>
          </span>
        </div>
      </div>

      <div id="chatMessages">
        <div class="msg them">
          <div class="meta">System</div>
          Welcome. Type a message or hit GIF.
        </div>
      </div>

      <div class="composer">
        <input id="messageInput" type="text" placeholder="Type your message…" autocomplete="off" />
        <button id="gifBtn" class="btn" type="button">GIF</button>
        <button id="sendBtn" class="btn btnPrimary" type="button">Send</button>
      </div>
    </div>
  </div>

  <!-- GIF MODAL -->
  <div id="gifModal">
    <div class="modalBox">
      <div class="modalTop">
        <input id="gifSearch" type="text" placeholder="Search GIFs (press Enter) — or leave blank for Trending" />
        <button id="gifTrending" class="btn" type="button">Trending</button>
        <button id="gifClose" class="btn" type="button">Close</button>
      </div>
      <div class="hint">Tip: Press Enter to search. Click a GIF to send it to chat.</div>
      <div id="gifResults"></div>
    </div>
  </div>

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    // SETTINGS
    const ROOM = "ma3dtribe";
    const GIPHY_API_KEY = "3zxGKg42FRkYfKmUrnjmobhQch37O33L";
    const USER_STORAGE_KEY = "ma3dtribe_username";

    const SUPABASE_URL = "https://tgqfplueqjhsywkcjaal.supabase.co";
    const SUPABASE_ANON_KEY = "sb_publishable_xzNaO0t5I2iCmv3LzYG9Ow_K8ZS9s0u";

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ELEMENTS
    const chatMessages = document.getElementById("chatMessages");
    const messageInput = document.getElementById("messageInput");
    const sendBtn = document.getElementById("sendBtn");

    const userDisplay = document.getElementById("userDisplay");
    const changeNameBtn = document.getElementById("changeName");

    const gifBtn = document.getElementById("gifBtn");
    const gifModal = document.getElementById("gifModal");
    const gifClose = document.getElementById("gifClose");
    const gifTrending = document.getElementById("gifTrending");
    const gifSearch = document.getElementById("gifSearch");
    const gifResults = document.getElementById("gifResults");

    // USERNAME
    function getWebsiteUsername() {
      let name = (localStorage.getItem(USER_STORAGE_KEY) || "").trim();
      if (!name) {
        name = (prompt("Enter your website username for chat:") || "").trim();
        if (!name) name = "Guest";
        localStorage.setItem(USER_STORAGE_KEY, name);
      }
      return name;
    }
    function setWebsiteUsername(newName) {
      const clean = (newName || "").trim() || "Guest";
      localStorage.setItem(USER_STORAGE_KEY, clean);
      USERNAME = clean;
      userDisplay.textContent = USERNAME;
    }
    let USERNAME = getWebsiteUsername();
    userDisplay.textContent = USERNAME;

    changeNameBtn.addEventListener("click", () => {
      const newName = prompt("Change your chat name:", USERNAME);
      if (newName !== null) setWebsiteUsername(newName);
      messageInput.focus();
    });

    // HELPERS
    function scrollChatToBottom() {
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }
    function addMessageContainer(who = "me", nameOverride = null) {
      const bubble = document.createElement("div");
      bubble.className = `msg ${who}`;

      const meta = document.createElement("div");
      meta.className = "meta";
      meta.textContent = nameOverride || USERNAME;

      bubble.appendChild(meta);
      return bubble;
    }
    function addTextMessage(text, who = "me", nameOverride = null) {
      const bubble = addMessageContainer(who, nameOverride);
      const content = document.createElement("div");
      content.textContent = text;
      bubble.appendChild(content);
      chatMessages.appendChild(bubble);
      scrollChatToBottom();
    }
    function addGifMessage(url, who = "me", nameOverride = null) {
      const bubble = addMessageContainer(who, nameOverride);
      const img = document.createElement("img");
      img.src = url;
      img.alt = "gif";
      img.loading = "lazy";
      bubble.appendChild(img);
      chatMessages.appendChild(bubble);
      scrollChatToBottom();
    }

    // SUPABASE: save
    async function saveMessage(kind, context) {
      const { error } = await supabase.from("messages").insert({
        room: ROOM,
        username: USERNAME,
        kind,
        context,
        source: "web"
      });

      if (error) {
        console.error("Supabase insert error:", error);
        addTextMessage("Supabase insert failed (check Console).", "them", "System");
      }
    }

    // SEND TEXT
    async function sendCurrentText() {
      const text = (messageInput.value || "").trim();
      if (!text) return;
      addTextMessage(text, "me");
      messageInput.value = "";
      messageInput.focus();
      await saveMessage("text", text);
    }
    sendBtn.addEventListener("click", sendCurrentText);
    messageInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") sendCurrentText();
    });

    // GIF MODAL
    function openGifModal() {
      gifModal.classList.add("show");
      gifSearch.value = "";
      gifResults.textContent = "Loading trending GIFs...";
      loadTrending();
      gifSearch.focus();
    }
    function closeGifModal() {
      gifModal.classList.remove("show");
      messageInput.focus();
    }
    gifBtn.addEventListener("click", openGifModal);
    gifClose.addEventListener("click", closeGifModal);
    gifTrending.addEventListener("click", loadTrending);
    gifModal.addEventListener("click", (e) => {
      if (e.target === gifModal) closeGifModal();
    });

    // GIPHY
    async function loadTrending() {
      gifResults.textContent = "Loading trending GIFs...";
      try {
        const url = `https://api.giphy.com/v1/gifs/trending?api_key=${encodeURIComponent(GIPHY_API_KEY)}&limit=18&rating=pg-13`;
        const res = await fetch(url);
        const json = await res.json();
        if (!res.ok) { gifResults.textContent = "GIPHY error."; return; }
        renderGifGrid(json.data || []);
      } catch (err) {
        gifResults.textContent = "Network error: " + err.message;
      }
    }
    gifSearch.addEventListener("keydown", async (e) => {
      if (e.key !== "Enter") return;
      const q = gifSearch.value.trim();
      if (!q) return loadTrending();

      gifResults.textContent = "Searching...";
      try {
        const url = `https://api.giphy.com/v1/gifs/search?api_key=${encodeURIComponent(GIPHY_API_KEY)}&q=${encodeURIComponent(q)}&limit=18&rating=pg-13`;
        const res = await fetch(url);
        const json = await res.json();
        if (!res.ok) { gifResults.textContent = "GIPHY error."; return; }
        renderGifGrid(json.data || []);
      } catch (err) {
        gifResults.textContent = "Network error: " + err.message;
      }
    });
    function renderGifGrid(gifs) {
      gifResults.innerHTML = "";
      gifs.forEach(g => {
        const imgUrl = g?.images?.fixed_width?.url;
        if (!imgUrl) return;

        const img = document.createElement("img");
        img.src = imgUrl;
        img.loading = "lazy";
        img.addEventListener("click", async () => {
          addGifMessage(imgUrl, "me");
          closeGifModal();
          await saveMessage("gif", imgUrl);
        });
        gifResults.appendChild(img);
      });
    }

    window.addEventListener("load", () => messageInput.focus());
  </script>
</body>
</html>
