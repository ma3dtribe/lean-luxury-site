<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MA3DTRIBE Chat Test</title>
</head>
<body>
  <h1 style="color:red">CHAT TEST LOADED</h1>

  <h2>MA3DTRIBE Chat Test</h2>

  <div id="status" style="opacity:.8;margin-bottom:8px;"></div>

  <div id="messages" style="border:1px solid #ccc;height:300px;overflow:auto;padding:10px;"></div>

  <div style="margin-top:10px;">
    <input id="text" placeholder="Type a message" style="width:70%;padding:8px;" />
    <button id="send" style="padding:8px 12px;">Send</button>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import {
      getFirestore,
      collection,
      addDoc,
      serverTimestamp,
      query,
      orderBy,
      onSnapshot,
      limit
    } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

    // ✅ Replace with your real Firebase config
    const firebaseConfig = {
      apiKey: "PASTE_HERE",
      authDomain: "PASTE_HERE",
      projectId: "PASTE_HERE",
      storageBucket: "PASTE_HERE",
      messagingSenderId: "PASTE_HERE",
      appId: "PASTE_HERE"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const guestName =
      localStorage.getItem("guestName") ||
      (() => {
        const name = "Guest-" + Math.floor(Math.random() * 900 + 100);
        localStorage.setItem("guestName", name);
        return name;
      })();

    const statusEl = document.getElementById("status");
    const messagesEl = document.getElementById("messages");
    const textEl = document.getElementById("text");
    const sendBtn = document.getElementById("send");

    statusEl.textContent = "Signed in as: " + guestName;

    // ✅ Realtime listener (last 100 messages by createdAtMs)
    const q = query(
      collection(db, "messages"),
      orderBy("createdAtMs", "asc"),
      limit(100)
    );

    onSnapshot(q, (snap) => {
      messagesEl.innerHTML = "";
      snap.forEach((doc) => {
        const m = doc.data();
        const row = document.createElement("div");
        const name = (m.displayName || "Unknown").replaceAll("<", "&lt;");
        const text = (m.text || "").replaceAll("<", "&lt;");
        row.innerHTML = "<strong>" + name + "</strong>: " + text;
        messagesEl.appendChild(row);
      });
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }, (err) => {
      statusEl.textContent = "Listener error: " + err.message;
      console.error(err);
    });

    async function send() {
      const text = textEl.value.trim();
      if (!text) return;

      try {
        await addDoc(collection(db, "messages"), {
          source: "web",
          displayName: guestName,
          text,
          gifUrl: null,
          createdAtMs: Date.now(),
          timestamp: serverTimestamp()
        });
        textEl.value = "";
        textEl.focus();
      } catch (err) {
        statusEl.textContent = "Send error: " + err.message;
        console.error(err);
      }
    }

    sendBtn.addEventListener("click", send);
    textEl.addEventListener("keydown", (e) => {
      if (e.key === "Enter") send();
    });
  </script>
</body>
</html>
